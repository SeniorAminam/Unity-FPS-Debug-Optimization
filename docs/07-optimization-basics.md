# ⚡ اصول بهینه‌سازی

<div align="center">

**قوانین و استراتژی‌های بهینه‌سازی در Unity**

</div>

---

## 📏 قانون ۸۰/۲۰ (Pareto)

```
┌─────────────────────────────────────────────────────────────┐
│                    PARETO PRINCIPLE                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│    ┌───────────────────────────────────────────────────┐   │
│    │████████████████████│░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░│   │
│    │       20%          │            80%               │   │
│    │   کد مشکل‌ساز      │       کد معمولی            │   │
│    └───────────────────────────────────────────────────┘   │
│                          ▲                                  │
│                          │                                  │
│    ┌───────────────────────────────────────────────────┐   │
│    │████████████████████████████████████████│░░░░░░░░░░│   │
│    │                 80%                    │   20%    │   │
│    │              مشکل عملکرد               │  سایر   │   │
│    └───────────────────────────────────────────────────┘   │
│                                                             │
│    💡 نتیجه: ۲۰٪ کد، ۸۰٪ مشکلات را ایجاد می‌کند!          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### معنی عملی

```csharp
// به جای بهینه‌سازی همه چیز:
void Update() {
    // ۱۰ خط کد که هر کدام ۱ms طول می‌کشند
    Operation1();  // 1ms
    Operation2();  // 1ms
    Operation3();  // 1ms
    Operation4();  // 1ms
    Operation5();  // 1ms
    HeavyOperation();  // ⚠️ 50ms ← اینجا را بهینه کن!
    Operation7();  // 1ms
    Operation8();  // 1ms
    Operation9();  // 1ms
    Operation10(); // 1ms
}

// بهینه‌سازی HeavyOperation() بیشترین تأثیر را دارد!
```

---

## 📊 اندازه‌گیری قبل از بهینه‌سازی

### DON'T: حدس زدن

```csharp
// ❌ "فکر می‌کنم این کند است..."
void Update() {
    // حدس: foreach کند است!
    foreach (var enemy in enemies) {
        enemy.Update();
    }
}
```

### DO: اندازه‌گیری

```csharp
// ✅ اندازه‌گیری با Stopwatch
using System.Diagnostics;

void Update() {
    Stopwatch sw = Stopwatch.StartNew();
    
    foreach (var enemy in enemies) {
        enemy.Update();
    }
    
    sw.Stop();
    if (sw.ElapsedMilliseconds > 1) {
        UnityEngine.Debug.Log($"Enemies Update: {sw.ElapsedMilliseconds}ms");
    }
}
```

### استفاده از Profiler

```csharp
// بهتر: استفاده از Unity Profiler Markers

using Unity.Profiling;

static readonly ProfilerMarker s_EnemiesMarker = new ProfilerMarker("Enemies.Update");

void Update() {
    using (s_EnemiesMarker.Auto()) {
        foreach (var enemy in enemies) {
            enemy.Update();
        }
    }
}
```

---

## ⚠️ Premature Optimization is Evil

> *"Premature optimization is the root of all evil"*  
> — Donald Knuth

### معنی

```
┌─────────────────────────────────────────────────────────────┐
│                 OPTIMIZATION TIMELINE                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Development Phase:                                         │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐   │
│  │ Design │→│ Proto  │→│ Alpha  │→│ Beta   │→│Release │   │
│  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘   │
│                                         ▲                   │
│                                         │                   │
│                            بهینه‌سازی اینجا! ─────────────┘ │
│                                                             │
│  ❌ زودتر = وقت تلف شده                                    │
│  ❌ زودتر = کد پیچیده بی‌دلیل                              │
│  ✅ بعد از اثبات مشکل = بهینه‌سازی هدفمند                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### مثال عملی

```csharp
// ❌ بهینه‌سازی زودرس: Object Pool برای همه چیز!
public class OverEngineered : MonoBehaviour {
    private ObjectPool<Vector3> vectorPool;  // واقعاً لازم است؟!
    private ObjectPool<string> stringPool;   // struct pool؟!
    
    void Start() {
        // ۱۰۰ خط کد برای چیزی که شاید اصلاً مشکل نیست!
    }
}

// ✅ اول ساده بنویس، بعد اگر مشکل بود بهینه کن
public class SimpleFirst : MonoBehaviour {
    void Start() {
        var enemies = FindObjectsOfType<Enemy>();  // ساده!
        // اگر Profiler نشان داد کند است، بهینه‌سازی کن
    }
}
```

---

## 🎯 CPU-Bound vs GPU-Bound

### تشخیص

```
┌─────────────────────────────────────────────────────────────┐
│              CPU-BOUND vs GPU-BOUND                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  CPU-Bound (Scripts/Physics سنگین):                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ CPU: ████████████████████████████████████ 100%       │  │
│  │ GPU: ████████████░░░░░░░░░░░░░░░░░░░░░░░░  40%       │  │
│  └──────────────────────────────────────────────────────┘  │
│  → بهینه‌سازی Scripts/Physics لازم است                    │
│                                                             │
│  GPU-Bound (Rendering سنگین):                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ CPU: ████████████░░░░░░░░░░░░░░░░░░░░░░░░  40%       │  │
│  │ GPU: ████████████████████████████████████ 100%       │  │
│  └──────────────────────────────────────────────────────┘  │
│  → بهینه‌سازی Rendering/Shaders لازم است                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### در Profiler

```
CPU-Bound نشانه‌ها:
├── Scripts زمان زیادی می‌گیرند
├── WaitForGPU کم است یا نیست
└── Physics.Simulate سنگین است

GPU-Bound نشانه‌ها:
├── Rendering زمان زیادی می‌گیرد
├── WaitForGPU زیاد است
└── Draw Calls بالاست
```

---

## 🎮 Target Frame Rate و Budgeting

### تعیین Budget

```csharp
// Target: 60 FPS
// Budget per Frame: 16.67 ms

// تقسیم‌بندی پیشنهادی:
┌─────────────────────────────────────────────────────────────┐
│               16.67 ms FRAME BUDGET                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌────────────────────────────────────────────────────────┐│
│  │██████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░││
│  │ 5ms │                                                  ││
│  │Scripts                                                 ││
│  └────────────────────────────────────────────────────────┘│
│  ┌────────────────────────────────────────────────────────┐│
│  │░░░░░░████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░││
│  │      │3ms│                                             ││
│  │      Physics                                           ││
│  └────────────────────────────────────────────────────────┘│
│  ┌────────────────────────────────────────────────────────┐│
│  │░░░░░░░░░░████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░││
│  │          │  7ms  │                                     ││
│  │          Rendering                                     ││
│  └────────────────────────────────────────────────────────┘│
│  ┌────────────────────────────────────────────────────────┐│
│  │░░░░░░░░░░░░░░░░░░██░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░││
│  │                  1.67ms Buffer                         ││
│  └────────────────────────────────────────────────────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### تنظیم در Unity

```csharp
// تنظیم Target Frame Rate
void Start() {
    // برای موبایل با باتری
    #if UNITY_ANDROID || UNITY_IOS
    Application.targetFrameRate = 30;
    #else
    Application.targetFrameRate = 60;
    #endif
    
    // غیرفعال کردن VSync برای کنترل بیشتر
    QualitySettings.vSyncCount = 0;
}
```

---

## 📋 استراتژی بهینه‌سازی

### ترتیب صحیح

```
1. Make it Work       → اول کار کند
2. Make it Right      → بعد تمیز و درست باشد  
3. Make it Fast       → در آخر سریع باشد

┌─────────────────────────────────────────────────────────────┐
│                 OPTIMIZATION WORKFLOW                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│     ┌─────────┐                                            │
│     │ Profile │ ← قدم ۱: اندازه‌گیری                       │
│     └────┬────┘                                            │
│          ▼                                                  │
│     ┌─────────┐                                            │
│     │ Analyze │ ← قدم ۲: پیدا کردن Bottleneck              │
│     └────┬────┘                                            │
│          ▼                                                  │
│     ┌─────────┐                                            │
│     │Optimize │ ← قدم ۳: بهینه‌سازی هدفمند                │
│     └────┬────┘                                            │
│          ▼                                                  │
│     ┌─────────┐                                            │
│     │ Verify  │ ← قدم ۴: تأیید بهبود                       │
│     └────┬────┘                                            │
│          │                                                  │
│          ▼                                                  │
│     هنوز کند است؟ ──Yes──► برگرد به Profile               │
│          │                                                  │
│          No                                                 │
│          ▼                                                  │
│       Done! ✓                                               │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 💡 نکات کلیدی

```
✅ DO:
├── از Profiler استفاده کن
├── اول بنویس، بعد بهینه کن
├── فقط Bottleneck را بهینه کن
├── نتایج را اندازه بگیر
└── Trade-off ها را در نظر بگیر

❌ DON'T:
├── حدس نزن کجا کند است
├── همه چیز را بهینه نکن
├── کد را پیچیده نکن بدون دلیل
├── Micro-optimization زودرس
└── خوانایی را فدای سرعت نکن
```

---

## 🚀 بخش بعدی

در بخش بعدی، با **بهینه‌سازی حافظه** آشنا می‌شویم.

<div align="center">

**[⏮️ بخش قبلی](./06-common-bugs.md)** | **[⏭️ بخش بعدی: بهینه‌سازی حافظه](./08-memory-optimization.md)**

</div>

---

<div align="center">

*Developed by Amin Davodian*

</div>
